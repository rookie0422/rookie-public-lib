# 获取结构体成员大小



```c
 // 获取结构体成员大小
#define  get_member_size(type, member)   sizeof(((type*)0)->member)
```



## 示例：

```c

#include <stdio.h>   
 
// 获取结构体成员大小
#define  get_member_size(type, member)   sizeof(((type*)0)->member)



typedef struct _test_struct0
{
	char x;
	char y;
	char z;
}test_struct0;


typedef struct _test_struct1
{
	char a;
	char c;
	short b;
	int d;
	test_struct0 e;
}test_struct1;


int main(int arc, char* argv[])
{
	printf("GET_MEMBER_SIZE(test_struct1, a) = %ld\n", GET_MEMBER_SIZE(test_struct1, a));
	printf("GET_MEMBER_SIZE(test_struct1, c) = %ld\n", GET_MEMBER_SIZE(test_struct1, c));
	printf("GET_MEMBER_SIZE(test_struct1, b) = %ld\n", GET_MEMBER_SIZE(test_struct1, b));
	printf("GET_MEMBER_SIZE(test_struct1, d) = %ld\n", GET_MEMBER_SIZE(test_struct1, d));
	printf("GET_MEMBER_SIZE(test_struct1, e) = %ld\n", GET_MEMBER_SIZE(test_struct1, e));
	printf("test_struct1 size = %ld\n", sizeof(test_struct1));

	return 0;
}

```



# 获取结构体成员偏移量





```c
#define get_member_offsetof(TYPE, MEMBER) ((size_t) &((TYPE *)0)->MEMBER)

```



## **说明**：

- 获得结构体(TYPE)的变量成员(MEMBER)在此结构体中的偏移量。

- (01)  `( (TYPE *)0 )`  将零转型为`TYPE`类型指针，即`TYPE`类型的指针的地址是0。
- (02)  `((TYPE *)0)->MEMBER`   访问结构中的数据成员。
- (03)  `&( ( (TYPE *)0 )->MEMBER ) ` 取出数据成员的地址。由于`TYPE`的地址是0，这里获取到的地址就是相对`MEMBER`在`TYPE`中的偏移。
- (04)  `(size_t)(&(((TYPE*)0)->MEMBER))`   结果转换类型。对于32位系统而言，`size_t`是unsigned int类型；对于64位系统而言，size_t是unsigned long类型。

## 示例：

```c
#include <stdio.h>

// 获得结构体(TYPE)的变量成员(MEMBER)在此结构体中的偏移量。
#define get_member_offsetof(TYPE, MEMBER) ((size_t) &((TYPE *)0)->MEMBER)

struct student
{
    char gender;
    int id;
    int age;
    char name[20];
};

void main()
{
    int gender_offset, id_offset, age_offset, name_offset;

    gender_offset = get_member_offsetof(struct student, gender);
    id_offset = get_member_offsetof(struct student, id);
    age_offset = get_member_offsetof(struct student, age);
    name_offset = get_member_offsetof(struct student, name);

    printf("gender_offset = %d\n", gender_offset);
    printf("id_offset = %d\n", id_offset);
    printf("age_offset = %d\n", age_offset);
    printf("name_offset = %d\n", name_offset);
}
```



# 获取指向整个结构体变量的指针





```c
#define get_container_of(ptr, type, member) ({          \
    const typeof( ((type *)0)->member ) *__mptr = (ptr);    \
    (type *)( (char *)__mptr - get_member_offsetof(type,member) );})
```



## **说明**：

- 根据"结构体`(type)`变量"中的"域成员变量`(member)`的指针`(ptr)`"来获取指向整个结构体变量的指针。
- (01) `typeof( ( (type *)0)->member )`   取出`member`成员的变量类型。
- (02) `const typeof( ((type *)0)->member ) *__mptr = (ptr)`   定义变量`__mptr`指针，并将`ptr`赋值给`__mptr`。经过这一步，`__mptr`为`member`数据类型的常量指针，其指向`ptr`所指向的地址。
- (04) `(char *)__mptr `  将`__mptr`转换为字节型指针。
- (05) `offsetof(type,member))`   就是获取"`member`成员"在"结构体`type`"中的位置偏移。
- (06) `(char *)__mptr - offsetof(type,member))`   就是用来获取"结构体`type`"的指针的起始地址（为`char *`型指针）。
- (07) `(type *)( (char *)__mptr - offsetof(type,member) )`   就是将"`char *`类型的结构体`type`的指针"转换为"`type *`类型的结构体`type`的指针"。



## **示例**:





```c
#include <stdio.h>
#include <string.h>

// 获得结构体(TYPE)的变量成员(MEMBER)在此结构体中的偏移量。
#define get_member_offsetof(TYPE, MEMBER) ((size_t) &((TYPE *)0)->MEMBER)

// 根据"结构体(type)变量"中的"域成员变量(member)的指针(ptr)"来获取指向整个结构体变量的指针
#define get_container_of(ptr, type, member) ({          \
    const typeof( ((type *)0)->member ) *__mptr = (ptr);    \
    (type *)( (char *)__mptr - get_member_offsetof(type,member) );})

struct student
{
    char gender;
    int id;
    int age;
    char name[20];
};

void main()
{
    struct student stu;
    struct student *pstu;

    stu.gender = '1';
    stu.id = 9527;
    stu.age = 24;
    strcpy(stu.name, "zhouxingxing");

    // 根据"id地址" 获取 "结构体的地址"。
    pstu = get_container_of(&stu.id, struct student, id);

    // 根据获取到的结构体student的地址，访问其它成员
    printf("gender= %c\n", pstu->gender);
    printf("age= %d\n", pstu->age);
    printf("name= %s\n", pstu->name);
}
```

